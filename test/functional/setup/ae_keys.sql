/* DROP Column Encryption Keys first, Column Master Keys cannot be dropped until no CEKs depend on them */
IF EXISTS (SELECT * FROM sys.column_encryption_keys WHERE [name] LIKE '%AEColumnKey%' OR [name] LIKE '%-win-%')
BEGIN
DROP COLUMN ENCRYPTION KEY [AEColumnKey]
DROP COLUMN ENCRYPTION KEY [CEK-win-enclave]
DROP COLUMN ENCRYPTION KEY [CEK-win-enclave2]
DROP COLUMN ENCRYPTION KEY [CEK-win-noenclave]
DROP COLUMN ENCRYPTION KEY [CEK-win-noenclave2]
END
GO

/* Can finally drop Column Master Keys after the Column Encryption Keys are dropped */
IF EXISTS (SELECT * FROM sys.column_master_keys WHERE [name] LIKE '%AEMasterKey%' OR [name] LIKE '%-win-%')
BEGIN
DROP COLUMN MASTER KEY [AEMasterKey]
DROP COLUMN MASTER KEY [CMK-win-enclave]
DROP COLUMN MASTER KEY [CMK-win-noenclave]
END
GO

/* Create the Column Master Keys */
/* AKVMasterKey is a non-enclave enabled key for AE v1 testing */
/* The enclave-enabled master key requires an ENCLAVE_COMPUTATIONS clause */
CREATE COLUMN MASTER KEY [AEMasterKey]
WITH
(
    KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
    KEY_PATH = N'CurrentUser/my/237F94738E7F5214D8588006C2269DBC6B370816'
)
GO

/* The enclave-enabled master key requires an ENCLAVE_COMPUTATIONS clause */
CREATE COLUMN MASTER KEY [CMK-win-enclave]
WITH
(
    KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
    KEY_PATH = N'CurrentUser/My/FADD52207E002EDDEE832B12E281EA280F2EFBCB',
    ENCLAVE_COMPUTATIONS (SIGNATURE = 0x1D713C5C5993BB98B83994B3F8BC5514BB2D02AA6C7A97E51ABB13E4B7643F39A9035AB5511B0671C52B192A70045D1427AF60B1D4F16207BA26131FBC6ADBB2597FF1F322407EAAE3E1FBB47DDD2E47BAEB85CD1DD25E82D771ECFA230E05240A1966077F2EC6B029020A3C060B1240DEB485DB45F203DDB2DFC4B107A3EB8A265A10F3018092DEFC2B87E860AA7F4C7D0168547253A6F1C05BC9D8550A7DA90775E2E0A7454E1F2DC889B067BC8FC27A55453895D7A0B86756AA67953553209675482DA7AFB533E380AF4DB8F3C6D0AF62B319090BADFBF4B434E005510772295914AF60B0999E5B5A775AD77E7DA134A75D7038AA672B5A38F7C9A24DEE51)
)
GO


CREATE COLUMN MASTER KEY [CMK-win-noenclave]
WITH
(
    KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
    KEY_PATH = N'CurrentUser/My/FADD52207E002EDDEE832B12E281EA280F2EFBCB'
)
GO


/* Now we can create the Column Encryption Keys */
/* ENCRYPTED_VALUE is generated by SSMS and it is always the same if the same Certificate is imported */
CREATE COLUMN ENCRYPTION KEY [AEColumnKey]
WITH VALUES
(
    COLUMN_MASTER_KEY = [AEMasterKey],
    ALGORITHM = 'RSA_OAEP',
    ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F00320033003700660039003400370033003800650037006600350032003100340064003800350038003800300030003600630032003200360039006400620063003600620033003700300038003100360039DE2397A08F6313E7820D75382D8469BE1C8F3CD47E3240A5A6D6F82D322F6EB1B103C9C47999A69FFB164D37E7891F60FFDB04ADEADEB990BE88AE488CAFB8774442DF909D2EF8BB5961A5C11B85BA7903E0E453B27B49CE0A30D14FF4F412B5737850A4C564B44C744E690E78FAECF007F9005E3E0FB4F8D6C13B016A6393B84BB3F83FEED397C4E003FF8C5BBDDC1F6156349A8B40EDC26398C9A03920DD81B9197BC83A7378F79ECB430A04B4CFDF3878B0219BB629F5B5BF3C2359A7498AD9A6F5D63EF15E060CDB10A65E6BF059C7A32237F0D9E00C8AC632CCDD68230774477D4F2E411A0E4D9B351E8BAA87793E64456370D91D4420B5FD9A252F6D9178AE3DD02E1ED57B7F7008114272419F505CBCEB109715A6C4331DEEB73653990A7140D7F83089B445C59E4858809D139658DC8B2781CB27A749F1CE349DC43238E1FBEAE0155BF2DBFEF6AFD9FD2BD1D14CEF9AC125523FD1120488F24416679A6041184A2719B0FC32B6C393FF64D353A3FA9BC4FA23DFDD999B0771A547B561D72B92A0B2BB8B266BC25191F2A0E2F8D93648F8750308DCD79BE55A2F8D5FBE9285265BEA66173CD5F5F21C22CC933AE2147F46D22BFF329F6A712B3D19A6488DDEB6FDAA5B136B29ADB0BA6B6D1FD6FBA5D6A14F76491CB000FEE4769D5B268A3BF50EA3FBA713040944558EDE99D38A5828E07B05236A4475DA27915E
)
GO

/* There are two enclave enabled keys and two non-enclave enabled keys to test the case where a user
   tries to reencrypt a table from one enclave enabled key to another enclave enabled key, or from a
   non-enclave key to another non-enclave key */
CREATE COLUMN ENCRYPTION KEY [CEK-win-enclave]
WITH VALUES
(
    COLUMN_MASTER_KEY = [CMK-win-enclave],
    ALGORITHM = 'RSA_OAEP',
    ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F006600610064006400350032003200300037006500300030003200650064006400650065003800330032006200310032006500320038003100650061003200380030006600320065006600620063006200C74D0CBC932749664EBCDAD32C18A2F8CD4F284ECE0641BE48A2E43BD860EECC1582667F6B6987192B0EB7C62F6538031DC393AADFC60D5136EE4CEA18CC4253BA4FD63BCA547C34B75C747282BB2822D44543192DBD7FCB90F3E0FD49CD9FED5735DB0607120FF986FEC8818107691CE0AE31FB6A9F18BFDD6A5A19139629EC2E4BADC8D7E91218F148F6A1785DC44D2C6503C1DCE1E94B54568692881A7C9B4D65F530F68F8B0A0FA699564005F0CC9F59DCADEC309F12DC3118836AC8FA991F34BB2276D2ADB888832439A5EEE78EA0BC2584D730FD3A8526BFD5D7472DC360D20367FC70C65075076E79DA30FD99F9A28E54189777155D4010D38A09F96B6BF5EC14BD4CA24DA30F6AA75CA3D59B2B00622814829A18291ADD52E7E0BD18050CEAFE6E1070A0949F99A82668BA73108F6400275949FBBE88774D33333DD5992F98D017241FD657B7441A21B2465BF8C6FEF7BAB04B69FABDCD27834D83B1D7B41201DE733D8F834335B13DF6CBDF77FEB5233AE1AEE75A83D8AB9B8CAC584870A5F79CF860DF61E629A3CFFE3FD322007116CA246D04869583D4BB63CCC9B73EBC4CA28796B83F1DB90331F9676AEEB92A8683EB938D30CEA32E456508B50FAA7BA217CD672CB90D41D95DE0B730A4A3EE12FD6448DA533C33EC56ECC7941F690F16649DE19D236F30B62DC2192F82BB071EAEDE9FEBAF35110616218CCA
)
GO


CREATE COLUMN ENCRYPTION KEY [CEK-win-enclave2]
WITH VALUES
(
    COLUMN_MASTER_KEY = [CMK-win-enclave],
    ALGORITHM = 'RSA_OAEP',
    ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F006600610064006400350032003200300037006500300030003200650064006400650065003800330032006200310032006500320038003100650061003200380030006600320065006600620063006200140A7649C12D98A1E3126E8DCE15322AFD96DEBC2520A2DF6D43D162B9BB1C53AF1442887AFDE3E9E1AB473A93780E5A5EC655027BB1309D0B2CE0C2873BA62978BC9AAA485E95482A66436BD96A0DC4D85E3889428C704E29705CD92E853CA8D2520CEF7D299803BACDA2BEED8DB714C1FFFD1A197991D7FC2CB24A65B4BE972E41DDC306218B825E22FD68B49E5EC8064ABBFBC3A3DAE43A1F0215D0F391D38FC5665F798C61A2F992F33EBC0CC59C10AC27ADB5E18958D9BD9B5F134E841A2CD71B9169C74DCDA68D48C5B8BFFE4D4F5A2433DF675028B42758601AD86B4DF8FD58AA5789017B525BFF4E5499A4CCBAEB1E1D7E3F1AC0FFF9CF2F0BF68A25182F794DC26BCBC667D7F9543DB767D0519BC4A412980E7340C04DE3F3CB97EED7E1B316B8271BA3C2FBD5459F42D48411BFE442D23769E26EAC6AB4D3A95700D36D6BB8E0CCC7DAD1C26243150EE3B2187BA6285E698037DD755D2F114FD29079B358B6250744CEADECD1C162D409B0E0CFDAC0DCEADA4CDD923FF070577E9496AC1B28329CD566239A10C472868FB0D87A620FBDAF5A5AFE34B95F7F7E3423096F9A98FC80F1A2C04D41A6ABB5346726748054180137E8AB99AEC6A324C39A4CE74A56229791E51434AD8FD494E3E71FFDA09D523B71AF477A0F979C5C344F5F472E4996B5C02378FE75160EF264F962813245C90CC3D344E81DE726172374
)
GO


CREATE COLUMN ENCRYPTION KEY [CEK-win-noenclave]
WITH VALUES
(
    COLUMN_MASTER_KEY = [CMK-win-noenclave],
    ALGORITHM = 'RSA_OAEP',
    ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F0066006100640064003500320032003000370065003000300032006500640064006500650038003300320062003100320065003200380031006500610032003800300066003200650066006200630062008F9065DCDDC5B2340491D42571C1F25FCBE640F8585C27016F017F28AD913D62943634C443ADBA8FD775F1B90C37306B8D1998123C101155AEB0FC6DFCA8C09860ABF48B903248E4AA6C49784954931ACD96992A4966DAD08DAE01A0429AD99D52F8666F7FF11ED6A9296E5E4449DB39595AE77E8AC555B3859740C0AE93977E6134F0CA23A408880C37E87035F7C8C18389AA3453C46709E7EAC455EDB6F3526D28A7E64F118588DC17696EFFA2D916ED182EAA82E115EB02CDF63E45AAE0124E36F996B7E2BD68F2314F0ADDD969544B6D203A7F598453174B8B007476F1795EB1A9191E0671A89045F2A6196DE17094B65AA136A04FFF3586D49919F27C1988A30E39CC0F424995CF71C9CC8E4929E612400A761D6418F0DE92B2C9DACFBD2175980E41B69105D4299E697E812038F4B9D7A57989FA3A24CDA7CB0C87B235FDA42B3FEFBAFFBB1FCF26A46C0086BCB86940B0C31F2FE84FBEC95DA855F3B15F47485E806DE785A3C149C88A68B18DD427F7D40D604FA191E591182E1B7D661258BE10AF120C0DEEDE861D67C5C562764C49505E86362EA9A03F525856A45B33B80C9884B37EF7033A82D916C60380C86690E6234D9649F72839DC882A77BCD16146347F58DA38718E4D1EFE49A8ECDCB415AC9D087E07F1852A493819582DB07E494E98AF7BB6C038710F307AEB21341319CC6DDD1E7EC73B966C33717A59
)
GO


CREATE COLUMN ENCRYPTION KEY [CEK-win-noenclave2]
WITH VALUES
(
    COLUMN_MASTER_KEY = [CMK-win-noenclave],
    ALGORITHM = 'RSA_OAEP',
    ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F0066006100640064003500320032003000370065003000300032006500640064006500650038003300320062003100320065003200380031006500610032003800300066003200650066006200630062005E373B7807120EA34B87BAE958A2B4CC7049802B9EDDBC86B14B8F051E036CF0D786C35EA36AA553C14A71DF10DFD04C566D9F5999649F75DD7D5053A3AE6344A52948819723765ACF7C0FA2ED547F161CCCE6B1F2E33AB910500B9C343BE5CF142C9D46F36518508036B6E0BA19F79FC611FEBEBD2D5B2FBC145CD9F782B6106E52246BF486D4D28EC9955576D6D8BE69EE39254AF3537D34D0B466484B1C570D9AD7F1F0977F0B17E33B1EE43E166A861B1974EA7C69C1E66B793DC9021E1FE9DD9CD0A55ED96FA5C34CAA07E316BC59243B26CF30A0CAE90BEDBB411B46BDF11A8D82F82567F52AB98D6BF4FAC60C758C3F64146817128CDEAA76341954FE3831278CEA5DABBA6FE80A941FEDC946D8C20ED52B33099D9807D11BE2341FC9BF3CAE2F838BD302F9192E5727D375292BF93A9F1B4FF5CF3C032CF9FBE4601A706754F913263B470DF9D37186F58DAD6FC5496CF743714E08E8991DC61C12240A006F7E263EA66B92490C933437858C6C3C4C44D4481FA019F3083F96E9F713F15492D6DD12C3E1D4106635ADD3A82C9E396870187A9C6B2D2FF595885EAFFBB9571F192FFA25DE9A265A3B88BCD61F4A2A57D9FD08C57A2E80DA517780723E95A094E329FD23F3BFF0B34391DD72F84EF77E04AC89E8A5F1501D3B3D2769381937D3341915071C842E442BA167574AF484890E34579EFDFB945BBFF65E1157
)
GO

